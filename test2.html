<!doctype html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Asteroids 3D</title>


    <script src='./cannon.js'></script>
    <script src='https://threejs.org/build/three.min.js'></script>
    <script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
    <script src="https://threejs.org/examples/js/loaders/OBJLoader.js"></script>
    <script  src="https://threejs.org/examples/js/loaders/MTLLoader.js"></script>
    <script src="./js/Loop.js"></script>
    <!-- <script src="./util.js"></script> -->
</head>
<body>
    <script type='text/javascript'>
		var scene, camera, renderer;
var keyboard = {}, ship, asteroidArray = [];
var states = {
    initState: 'initState',
    playState: 'playState',
    endGameState: 'endGameState'
}
var spawnPoints = [
    {
        positionX:'3000',
        positionY:'3000',
        positionZ:'3000'
    },
    {
        positionX:'-3000',
        positionY:'3000',
        positionZ:'3000'
    },
    {
        positionX:'3000',
        positionY:'-3000',
        positionZ:'3000'
    },
    {
        positionX:'3000',
        positionY:'3000',
        positionZ:'-3000'
    },
    {
        positionX:'-3000',
        positionY:'-3000',
        positionZ:'3000'
    },
    {
        positionX:'3000',
        positionY:'-3000',
        positionZ:'-3000'
    },
    {
        positionX:'-3000',
        positionY:'3000',
        positionZ:'-3000'
    },
    {
        positionX:'-3000',
        positionY:'-3000',
        positionZ:'-3000'
    }]
var numAsteroids = 0;
var maxAsteroids = 5;
var currentState = states.initState;
var hearts = [];

// crosshair init
var vert_geo = new THREE.PlaneGeometry( .5, 2, 0.1 );
var hor_geo = new THREE.PlaneGeometry( 2, .5, 0.1 );
planeMaterial = new THREE.MeshBasicMaterial( {color: 0xCCCF11, side: THREE.DoubleSide} );
var cross_hair_up = new THREE.Mesh( vert_geo, planeMaterial );
var cross_hair_down = new THREE.Mesh( vert_geo, planeMaterial );
var cross_hair_left = new THREE.Mesh( hor_geo, planeMaterial );
var cross_hair_right = new THREE.Mesh( hor_geo, planeMaterial );

// Keeps the crosshair in always on screen
cross_hair_up.renderOrder = 999;
cross_hair_up.onBeforeRender = function( renderer ) { renderer.clearDepth(); };
cross_hair_down.renderOrder = 999;
cross_hair_down.onBeforeRender = function( renderer ) { renderer.clearDepth(); };
cross_hair_left.renderOrder = 999;
cross_hair_left.onBeforeRender = function( renderer ) { renderer.clearDepth(); };
cross_hair_right.renderOrder = 999;
cross_hair_right.onBeforeRender = function( renderer ) { renderer.clearDepth(); };

init();

function initRenderer() {
  renderer = new THREE.WebGLRenderer();
  renderer.setSize ( window.innerWidth, window.innerHeight );
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.BasicShadowMap;
  document.body.appendChild( renderer.domElement );
}

function initCamera() {
    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 20000);
    camera.position.set(100, 80, 0);
    cameraControls = new THREE.OrbitControls(camera, renderer.domElement);
      cameraControls.addEventListener("change", function() {
       camera.updateProjectionMatrix();
//   ship.rotation.set(camera.rotation.x, camera.rotation.y + Math.PI, Math.abs(camera.rotation.z))
		ship.lookAt(-camera.position.x,-camera.position.y,-camera.position.z);

    // keeps crosshair always in the center
    cross_hair_up.position.copy( camera.position );
    cross_hair_up.rotation.copy( camera.rotation );
    cross_hair_up.updateMatrix();
    cross_hair_up.translateX( 0 );
    cross_hair_up.translateY( 33 );
    cross_hair_up.translateZ( - 80 );

    cross_hair_down.position.copy( camera.position );
    cross_hair_down.rotation.copy( camera.rotation );
    cross_hair_down.updateMatrix();
    cross_hair_down.translateX( 0 );
    cross_hair_down.translateY( 27 );
    cross_hair_down.translateZ( - 80 );

    cross_hair_left.position.copy( camera.position );
    cross_hair_left.rotation.copy( camera.rotation );
    cross_hair_left.updateMatrix();
    cross_hair_left.translateX( -3 );
    cross_hair_left.translateY( 30 );
    cross_hair_left.translateZ( - 80 );

    cross_hair_right.position.copy(camera.position );
    cross_hair_right.rotation.copy( camera.rotation );
    cross_hair_right.updateMatrix();
    cross_hair_right.translateX( 3 );
    cross_hair_right.translateY( 30 );
    cross_hair_right.translateZ( - 80 );

    // hearts
    // makes sure hearts are always showing
    for(var i = 0; i<3; i++){
      hearts[i].renderOrder = 999;
      hearts[i].onBeforeRender = function( renderer ) { renderer.clearDepth(); };
    }

    hearts[0].position.copy( camera.position );
    hearts[0].rotation.copy( camera.rotation );
    hearts[0].updateMatrix();
    hearts[0].translateX( 100 );
    hearts[0].translateY( -50 );
    hearts[0].translateZ( - 80 );
    hearts[0].rotateX(-Math.PI/2);

    hearts[1].position.copy( camera.position );
    hearts[1].rotation.copy( camera.rotation );
    hearts[1].updateMatrix();
    hearts[1].translateX( 85 );
    hearts[1].translateY( -50 );
    hearts[1].translateZ( -80 );
    hearts[1].rotateX(-Math.PI/2);

    hearts[2].position.copy( camera.position );
    hearts[2].rotation.copy( camera.rotation );
    hearts[2].updateMatrix();
    hearts[2].translateX( 70 );
    hearts[2].translateY( -50 );
    hearts[2].translateZ( -80 );
    hearts[2].rotateX(-Math.PI/2);

    render();
  });
}

function initSkyBox(){
  var materialArray = [];
  materialArray.push(new THREE.MeshBasicMaterial({
    map: THREE.ImageUtils.loadTexture('images/cwd_lf.jpg')
  }));
  materialArray.push(new THREE.MeshBasicMaterial({
    map: THREE.ImageUtils.loadTexture('images/cwd_rt.jpg')
  }));
  materialArray.push(new THREE.MeshBasicMaterial({
    map: THREE.ImageUtils.loadTexture('images/cwd_up.jpg')}));
  materialArray.push(new THREE.MeshBasicMaterial({map: THREE.ImageUtils.loadTexture('images/cwd_dn.jpg')
}));
  materialArray.push(new THREE.MeshBasicMaterial({
    map: THREE.ImageUtils.loadTexture('images/cwd_ft.jpg')
  }));
  materialArray.push(new THREE.MeshBasicMaterial({
    map: THREE.ImageUtils.loadTexture('images/cwd_bk.jpg')
  }));

  for (var i = 0; i < 6; i++) materialArray[i].side = THREE.BackSide;

  var skyboxMaterial = new THREE.MeshFaceMaterial( materialArray );
  var skyboxGeom = new THREE.CubeGeometry( 5000, 5000, 5000, 1, 1, 1 );
  var skybox = new THREE.Mesh( skyboxGeom, skyboxMaterial );
  scene.add( skybox );
}

function initHearts() {
  for (var i=0; i<3; i++ ) {
    let material = new THREE.MeshBasicMaterial();
    let objLoader = new THREE.OBJLoader();
    let mtlLoader = new THREE.MTLLoader();

    mtlLoader.setPath('./assets/');
    mtlLoader.load("12190_Heart_v1_L3.mtl",function (mtls){
        mtls.preload();
        objLoader.setMaterials(mtls);
        objLoader.setPath("./assets/");
        objLoader.load("12190_Heart_v1_L3.obj",function ( obj ) {
            obj.scale.set(.5,.5,.5);
            obj.castShadow = false;
            obj.receiveShadow = false;
            scene.add(obj);
            hearts.push(obj);
        });
    });
  }

}

function initScene() {
let material = new THREE.MeshStandardMaterial();
    let objLoader = new THREE.OBJLoader();
    let mtlLoader = new THREE.MTLLoader();

    mtlLoader.setPath('./assets/');
    mtlLoader.load("Arc170.mtl",function (mtls){
        mtls.preload();
        objLoader.setMaterials(mtls);
        objLoader.setPath("./assets/");
        objLoader.load("Arc170.obj",function ( obj ) {
            obj.scale.set(0.05,0.05,0.05);
            obj.position.set(0,0,0);
            obj.rotation.set(0,-Math.PI/2,0);
			obj.castShadow = true;
			obj.receiveShadow = true;
			ship = obj;
            scene.add(ship);

            render();
        });
    });

    initHearts();

    let ambientLight = new THREE.AmbientLight(0xffffff, .1);
    ambientLight.position.set(0,0,0);
    scene.add(ambientLight);

    let sun = new THREE.PointLight(0xffffff, 10, 5000, 2);
    sun.position.set(0,2500,0);
    sun.angle = Math.PI /2;

    sun.castShadow = true;
    sun.shadow.mapSize.width = 512;
    sun.shadow.mapSize.height = 512;
    sun.shadow.camera.near = 0.1;
    sun.shadow.camera.far = 5000;
    sun.shadow.camera.fov = 100000;

    let eart = new THREE.PointLight(0x1111ee, 2.5, 5000, 2);
    eart.position.set(0,0,2500);
    eart.angle = Math.PI /2;

    eart.castShadow = true;
    eart.shadow.mapSize.width = 5000;
    eart.shadow.mapSize.height = 5000;
    eart.shadow.camera.near = 0.1;
    eart.shadow.camera.far = 5000;
    eart.shadow.camera.fov = 100000;

    scene.add(sun);
    scene.add(eart);

    initCamera();

    cross_hair_up.lookAt(-camera.position.x,-camera.position.y,-camera.position.z);
    cross_hair_down.lookAt(-camera.position.x,-camera.position.y,-camera.position.z);
    cross_hair_left.lookAt(-camera.position.x,-camera.position.y,-camera.position.z);
    cross_hair_right.lookAt(-camera.position.x,-camera.position.y,-camera.position.z);

    scene.add( cross_hair_up );
    scene.add( cross_hair_down );
    scene.add( cross_hair_left );
    scene.add( cross_hair_right );

    render();
    initialAsteroid();
}

function init() {
  scene = new THREE.Scene();
  initRenderer();
  initSkyBox();
  initScene();
  animate();
}

var loop = new PhysicsLoop(60);

loop.add(function(delta){
    MoveAsteroids();
});

loop.start();

// updates asteroid position
function MoveAsteroids() {
    // var asteroid = asteroidArray[0];
    asteroidArray.forEach(function(asteroid)
    {
        if (asteroid.position.x < 0) {
            asteroid.position.x++;
        } else {
            asteroid.position.x--;
        }

        if (asteroid.position.y < 0) {
            asteroid.position.y++;
        } else {
            asteroid.position.y--;
        }

        if (asteroid.position.z < 0) {
            asteroid.position.z++;
        } else {
            asteroid.position.z--;
        }
    })
    render();
}

function animate() {
  requestAnimationFrame(animate);

  // Ship&Cam Rotation
  if(keyboard[32]) { //Space
    console.log("Shoot laserz!");
    var laserBeam	= new AnimateLaser();
    laserBeam.position.set(0,0,0);
    laserBeam.scale.set(1000, 10, 10);
    scene.add(laserBeam);
    scene.remove(laserBeam);
  }

  /*
  var keepLooping = true;
  while(keepLooping)
  {
    switch(currentState)
    {
        case states.initState:
            break;
        case states.playState:
            break;
        case states.endGameState:
            keepLooping = false;
            break;
        default:
            console.log("Should not enter here");
            break;
    }
  }
  */

  // Meteor Spawner

  // Game Over

  render();
}

//TODO choose random type when asteroid types are implemented
function initialAsteroid()
{
    let material = new THREE.MeshStandardMaterial();
    let objLoader = new THREE.OBJLoader();
    let mtlLoader = new THREE.MTLLoader();
    while(numAsteroids < maxAsteroids) {
        let position = spawnPoints[Math.floor(Math.random() * 8)];
        mtlLoader.setPath('./assets/');
        mtlLoader.load( "asteroid1.mtl", function (mtls){
            mtls.preload();
            objLoader.setMaterials(mtls);
            objLoader.setPath("./assets/");

            objLoader.load("asteroid1.obj", function ( obj ) {
                obj.scale.set(0.5,0.5,0.5);
                obj.position.set(position.positionX,position.positionY,position.positionZ);
				obj.rotation.set(0,-Math.PI/2,0)
				obj.castShadow = true;
				obj.receiveShadow = true;

                asteroid = obj;
                asteroidArray[numAsteroids] = asteroid;
                numAsteroids++;
                scene.add(asteroid);
                render();
            });
        });
        numAsteroids++;
    }
}

function update() {
}

function render() {
  renderer.render(scene, camera);
}

function keyDown(event){
    keyboard[event.keyCode] = true;
}
function keyUp(event){
    keyboard[event.keyCode] = false;
}

function AnimateLaser(){
    var object3d	= new THREE.Object3D()
    // generate the texture
    var canvas	= generateLaserBodyCanvas()
    var texture	= new THREE.Texture( canvas )
    texture.needsUpdate	= true;
    // do the material
    var material	= new THREE.MeshBasicMaterial({
        map		: texture,
        blending	: THREE.AdditiveBlending,
        color		: 0x4444aa,
        side		: THREE.DoubleSide,
        depthWrite	: false,
        transparent	: true
    })
    var geometry	= new THREE.PlaneGeometry(1, 0.1)
    var nPlanes	= 16;
    for (var i = 0; i < nPlanes; i++){
        var mesh	= new THREE.Mesh(geometry, material)
        mesh.position.x	= 1/2
        mesh.rotation.x	= i/nPlanes * Math.PI
        object3d.add(mesh)
    }
    return object3d;

    function generateLaserBodyCanvas(){
        // init canvas
        var canvas	= document.createElement( 'canvas' );
        var context	= canvas.getContext( '2d' );
        canvas.width	= 1;
        canvas.height	= 64;
        // set gradient
        var gradient	= context.createLinearGradient(0, 0, canvas.width, canvas.height);
        gradient.addColorStop( 0  , 'rgba(  0,  0,  0,0.1)' );
        gradient.addColorStop( 0.1, 'rgba(160,160,160,0.3)' );
        gradient.addColorStop( 0.5, 'rgba(255,255,255,0.5)' );
        gradient.addColorStop( 0.9, 'rgba(160,160,160,0.3)' );
        gradient.addColorStop( 1.0, 'rgba(  0,  0,  0,0.1)' );
        // fill the rectangle
        context.fillStyle	= gradient;
        context.fillRect(0,0, canvas.width, canvas.height);
        // return the just built canvas
        return canvas;
    }
}

window.addEventListener('keydown', keyDown);
window.addEventListener('keyup', keyUp);
</script>
</body>
</html>
